<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Image Classification With Cubical Filtrations and Persistence Images · Ripserer.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="Ripserer.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit">Ripserer.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../basics/">Basics</a></li><li><a class="tocitem" href="../stability/">Stability</a></li><li><a class="tocitem" href="../cocycles/">Representative Cocycles</a></li><li><a class="tocitem" href="../sublevelset/">Sublevel Set Persistent Homology</a></li><li class="is-active"><a class="tocitem" href>Image Classification With Cubical Filtrations and Persistence Images</a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../../api/ripserer/">Ripserer</a></li><li><a class="tocitem" href="../../api/filtrations/">Filtrations</a></li><li><a class="tocitem" href="../../api/simplices/">Simplices</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Image Classification With Cubical Filtrations and Persistence Images</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Image Classification With Cubical Filtrations and Persistence Images</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/mtsch/Ripserer.jl/blob/master/docs/src/examples/malaria.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Image-Classification-With-Cubical-Filtrations-and-Persistence-Images-1"><a class="docs-heading-anchor" href="#Image-Classification-With-Cubical-Filtrations-and-Persistence-Images-1">Image Classification With Cubical Filtrations and Persistence Images</a><a class="docs-heading-anchor-permalink" href="#Image-Classification-With-Cubical-Filtrations-and-Persistence-Images-1" title="Permalink"></a></h1><p>In this example, we will show how to use Ripserer in an image classification context. Persistent homology is not a predictive algorithm, but it can be used to extract useful features from data.</p><pre><code class="language-">using Ripserer
using PersistenceDiagrams
using Images # also required: ImageIO to read .png files
using Plots
using ProgressMeter
using Random
Random.seed!(1337)

data_dir = joinpath(@__DIR__, &quot;../assets/data/malaria&quot;) # replace with the correct path.
nothing # hide</code></pre><p>Let&#39;s load the data. We will use a a <a href="https://lhncbc.nlm.nih.gov/publication/pub9932">data set</a> with microscope images of healthy cells and cells infected with malaria. The original data set is quite large, but we can pretend we were only given 200 images to work with. We have chosen the 200 images randomly.</p><pre><code class="language-">uninfected = shuffle!(load.(readdir(joinpath(data_dir, &quot;uninfected&quot;), join=true)))
infected = shuffle!(load.(readdir(joinpath(data_dir, &quot;infected&quot;), join=true)))

images = [uninfected; infected]
classes = [fill(false, length(uninfected)); fill(true, length(infected))]
nothing # hide</code></pre><p>Let&#39;s see what the images look like.</p><pre><code class="language-">plot(plot(uninfected[1], title=&quot;Healthy&quot;),
     plot(uninfected[2], title=&quot;Healthy&quot;),
     plot(infected[1], title=&quot;Infected&quot;),
     plot(infected[2], title=&quot;Infected&quot;))</code></pre><p>To make the images work with Ripserer, we convert them to floating gray scale values. We do not have to resize the images. Maybe some additional preprocessing, such as normalization would help, but we&#39;ll skip it for this example.</p><pre><code class="language-">inputs = [Gray.(image) for image in images]
nothing # hide</code></pre><p>Now we can compute persistence diagrams. Since we are working with images, we have to use the <code>Cubical</code> filtration type. Cubical persistent homology should detect the dark spots (local minima) in the images. It&#39;s pretty efficient, so this should only take a few seconds.</p><pre><code class="language-">diagrams = @showprogress [ripserer(Cubical(i)) for i in inputs]</code></pre><p>This is what some of the diagrams look like.</p><pre><code class="language-">plot(plot(images[1], title=&quot;Healthy&quot;), plot(diagrams[1]))</code></pre><pre><code class="language-">plot(plot(images[end], title=&quot;Infected&quot;), plot(diagrams[end]))</code></pre><p>Notice that there is a lot more going on in the middle of the infected diagram, especially in <span>$H_0$</span>.</p><p>The persistence diagrams might look nice, but are hard to use with machine learning algorithms. The number of points in the diagram may be different for every image, even when images are of the same size. We can solve this problem by using a vectorization method, such as converting all diagrams to persistence images.</p><p>Persistence images work by weighting each point in the diagram with a distribution. The distribution defaults to a Gaussian, but any function of two arguments can be used. Each point is also weighted by a weighting function that should be equal to zero along the <span>$x$</span>-axis. It defaults to a function that is zero on the <span>$x$</span>-axis and linearly increases to the maximum persistence in the diagram.</p><p>We start by splitting the diagrams into their 0 and 1 dimensional components.</p><pre><code class="language-">dim_0 = first.(diagrams)
dim_1 = last.(diagrams)
nothing; # hide
nothing #hide</code></pre><p>We feed the diagram to the <code>PersistenceImage</code> constructor which will choose ranges that will fit all the diagrams. We set the sigma value to 0.1, since all persistence pairs are in the <span>$[0,1]×[0,1]$</span> square and the default sigma of 1 would be too wide. We will use the default image size, which is 5×5.</p><pre><code class="language-">image_0 = PersistenceImage(dim_0, sigma=0.1)</code></pre><pre><code class="language-">image_1 = PersistenceImage(dim_1, sigma=0.1)</code></pre><p>Let&#39;s see how some of the images look like.</p><pre><code class="language-">plot(plot(dim_0[end], persistence=true),
     heatmap(image_0(dim_0[end]), aspect_ratio=1))</code></pre><pre><code class="language-">plot(plot(dim_1[end], persistence=true),
     heatmap(image_1(dim_1[end]), aspect_ratio=1))</code></pre><p>Next, we convert all diagrams to images and use <code>vec</code> to turn them into flat vectors. We then concatenate the zero and one-dimensional images. The result is a vector of length 50 for each diagram.</p><pre><code class="language-">persims = [[vec(image_0(dim_0[i])); vec(image_1(dim_1[i]))]
           for i in 1:length(diagrams)]</code></pre><p>Now it&#39;s time to fit our model. We will use <a href="https://github.com/JuliaStats/GLMNet.jl">GLMNet.jl</a> to fit a regularized linear model.</p><pre><code class="language-">using GLMNet</code></pre><p>Convert the image vectors to a matrix that will be understood by <code>glmnet</code>.</p><pre><code class="language-">X = reduce(hcat, persims)&#39;
y = classes
nothing; # hide
nothing #hide</code></pre><p>Start by randomly splitting the data into two sets, a training and a testing set.</p><pre><code class="language-">perm = shuffle(1:200)
train_x = X[perm[1:100], :]
train_y = y[perm[1:100]]
test_x = X[perm[101:end], :]
test_y = y[perm[101:end]]
nothing; # hide
nothing #hide</code></pre><p>Fit the model and predict.</p><pre><code class="language-">path = glmnet(train_x, train_y)
cv = glmnetcv(train_x, train_y)

λ = path.lambda[argmin(cv.meanloss)]
path = glmnet(train_x, train_y; lambda=[λ])

predictions = .!iszero.(round.(GLMNet.predict(path, test_x)))
nothing; # hide
nothing #hide</code></pre><p>Get the classification accuracy.</p><pre><code class="language-">accuracy = count(predictions .== test_y) / length(test_y)</code></pre><p>Not half bad considering we haven&#39;t touched the images and we left pretty much all settings on default.</p><p>Now let&#39;s look at the misclassified examples.</p><pre><code class="language-">missed = findall(predictions .!= test_y)
label = (&quot;Healthy&quot;, &quot;Infected&quot;)
plts = [plot(images[i],
             title=&quot;$(label[test_y[i] + 1])&quot;,
             ticks=nothing)
        for i in missed]
plot(plts...)</code></pre><p>Finally, let&#39;s look at which parts of the persistence images <code>glmnet</code> considered important.</p><pre><code class="language-">plot(heatmap(reshape(path.betas[1:25], (5,5)), title=&quot;H₀ coefficients&quot;),
     heatmap(reshape(path.betas[26:50], (5,5)), title=&quot;H₁ coefficients&quot;))</code></pre><p>These correspond to the area we identified at the beginning. Also note that in this case, the classifier does not care about <span>$H_1$</span> at all.</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../sublevelset/">« Sublevel Set Persistent Homology</a><a class="docs-footer-nextpage" href="../../api/ripserer/">Ripserer »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 16 June 2020 05:07">Tuesday 16 June 2020</span>. Using Julia version 1.4.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
